#cloud-config


write-files:
  - path: /etc/conf.d/nfs
    permissions: '0644'
    content: |
      OPTS_RPC_MOUNTD=""

coreos:
  units:
    - name: rpc-statd.service
      command: start
      enable: true

    - name: output-CamHD_motion_metadata.mount
      command: start
      content: |
        [Mount]
        What=swarm-manager:/home/amarburg/CamHD_motion_metadata
        Where=/output/CamHD_motion_metadata
        Type=nfs

    - name: rqworker.service
      command: start
      content: |
        [Unit]
        Description=Start the RQ worker docker container

        [Service]
        ExecStartPre=/usr/bin/docker pull amarburg/camhd_motion_analysis_rq_worker:latest
        ExecStartPre=/usr/bin/bash -c "/usr/bin/systemctl set-environment RQ_REDIS_URL=$(curl \"http://metadata.google.internal/computeMetadata/v1/project/attributes/rq_redis_url\" -H \"Metadata-Flavor: Google\")"
        ExecStart=/usr/bin/docker run --rm --env REDIS_URL=${RQ_REDIS_URL}  --volume /output/CamHD_motion_metadata:/output/CamHD_motion_metadata --name rq-worker amarburg/camhd_motion_analysis_rq_worker:latest
        ExecStop=/usr/bin/docker stop rq-worker
        ExecStopPost=/usr/bin/docker rm rq-worker
        TimeoutStartSec=5m

        [Unit]
        After=output-CamHD_motion_metadata.mount,docker.socket
        Requires=output-CamHD_motion_metadata.mount,docker.socket
